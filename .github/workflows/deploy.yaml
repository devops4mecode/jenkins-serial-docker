name: Deploying

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: executing remote ssh commands using ssh key
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USER }}
          key: ${{ secrets.AWS_KEY }}
          port: 22
          script: |
            cd ~
            sudo rm -rf SN-Generator
            echo "============ CLONING REPO ============"
            sudo git clone https://cowcowhuat88:${{ secrets.TOKEN }}@github.com/cowcowhuat88/SN-Generator.git
            cd ~/SN-Generator/client
            echo "============ NPM INSTALL FRONTEND ============"
            sudo npm install --force
            echo "============ RUN BUILD ============"
            sudo npm run build
            echo "============ COPY AND PASTE BUILD FILE INTO /VAR/WWW/HTML ============"
            sudo cp -r ~/SN-Generator/client/build/* /var/www/html
            cd ~/SN-Generator/backend
            echo "============ NPM INSTALL BACKEND ============"
            sudo npm install --force
            echo "============ RESTART PM2 ============"
            sudo pm2 restart server.js
